---
import { getCollection } from "astro:content";
import SiteLayout from "../../layouts/SiteLayout.astro";
import FilterBar from "../../components/FilterBar.astro";
import { structural, STRUCTURAL_DEFAULT, STRUCTURAL_SCHEMES } from "../../config/taxonomy";

const allNotes = await getCollection("notes", ({ data }) => !data.draft);
const notes = allNotes;
const schemes = await getCollection("schemes");

const toTopicList = (value) => (Array.isArray(value) ? value : value ? [value] : []);

const getPreview = (body) => {
  const clean = body.replace(/\s+/g, " ").trim();
  const match = clean.match(/^(.*?[.!?])\s/);
  if (match) return match[1];
  return clean.slice(0, 160);
};
---

<SiteLayout title="my manual">
  <FilterBar slot="filters" mode="filter" current="notes" activeStructural={STRUCTURAL_DEFAULT} />

  <section
    class="note-list list-mode"
    data-filter-list
    data-default-struct={STRUCTURAL_DEFAULT}
    data-schemes-struct={STRUCTURAL_SCHEMES}
    data-struct-values={structural.join("|")}
  >
    {notes.map((note) => (
      <article
        class="note-card"
        data-note-card
        data-type="note"
        data-struct={note.data.structural}
        data-topics={toTopicList(note.data.topics).join("|")}
      >
        <a class="note-link" href={`/notes/${note.slug}/`}>
          <div class="note-head">
            <h2>{note.data.title}</h2>
          </div>
          <p class="note-preview">{getPreview(note.body)}</p>
        </a>
      </article>
    ))}
    {schemes.map((scheme) => (
      <article
        class="scheme-card"
        data-note-card
        data-type="scheme"
        data-struct={STRUCTURAL_SCHEMES}
        data-topics={toTopicList(scheme.data.topics).join("|")}
      >
        <a class="scheme-link" href={`/schemes/${scheme.slug}/`}>
          <div class="scheme-title">{scheme.data.title}</div>
          <div class="scheme-image">
            {scheme.data.image ? (
              <img src={scheme.data.image} alt={scheme.data.title} loading="lazy" />
            ) : null}
          </div>
        </a>
      </article>
    ))}
  </section>

  <script is:inline>
    const structButtons = Array.from(document.querySelectorAll("button[data-struct]"));
    const topicButtons = Array.from(document.querySelectorAll("button[data-topic]"));
    const cards = Array.from(document.querySelectorAll("[data-note-card]"));
    const list = document.querySelector("[data-filter-list]");
    const allowedStructs = new Set((list?.dataset.structValues || "").split("|").filter(Boolean));
    const schemesStruct = list?.dataset.schemesStruct || "";
    const params = new URLSearchParams(window.location.search);
    const paramStruct = params.get("struct");

    let activeStruct = allowedStructs.has(paramStruct || "") ? paramStruct : list?.dataset.defaultStruct || null;
    let activeTopic = null;

    const applyFilters = () => {
      cards.forEach((card) => {
        const cardStruct = card.dataset.struct || "";
        const cardTopics = (card.dataset.topics || "").split("|").filter(Boolean);
        const cardType = card.dataset.type || "note";

        let structOk = false;
        let topicsOk = false;

        const isDefault = activeStruct === list?.dataset.defaultStruct;

        if (cardType === "scheme") {
          structOk = isDefault || (schemesStruct && activeStruct === schemesStruct);
          topicsOk = !activeTopic || cardTopics.includes(activeTopic);
        } else {
          if (isDefault) {
            structOk = true;
          } else if (activeStruct === "НА ЗАМЕТКУ") {
            structOk = cardStruct === "НА ЗАМЕТКУ";
          } else {
            structOk = cardStruct === activeStruct;
          }

          if (activeTopic) {
            topicsOk = cardStruct !== "НА ЗАМЕТКУ" && cardTopics.includes(activeTopic);
          } else {
            topicsOk = true;
          }
        }

        card.style.display = structOk && topicsOk ? "block" : "none";
      });

      if (list) {
        list.classList.toggle("list-mode", activeStruct === list.dataset.defaultStruct && !activeTopic);
      }
    };

    structButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const value = btn.dataset.struct;
        if (!value) return;

        activeStruct = value;

        structButtons.forEach((b) => b.classList.toggle("is-active", b.dataset.struct === activeStruct));
        applyFilters();
      });
    });

    topicButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const value = btn.dataset.topic;
        if (!value) return;

        if (activeTopic === value) {
          activeTopic = null;
        } else {
          activeTopic = value;
        }

        topicButtons.forEach((b) => b.classList.toggle("is-active", b.dataset.topic === activeTopic));
        applyFilters();
      });
    });

    structButtons.forEach((b) => b.classList.toggle("is-active", b.dataset.struct === activeStruct));
    applyFilters();
  </script>
</SiteLayout>

<style>
  .note-list {
    display: grid;
    gap: 16px;
  }

  .note-list.list-mode {
    display: flex;
    flex-direction: column;
    gap: 12px;
  }

  .note-card {
    border: 1px solid var(--card-border);
    border-radius: 14px;
    background: var(--card);
    padding: 16px 18px;
    box-shadow: 0 0 24px rgba(255, 59, 79, 0.08);
  }

  .note-list.list-mode .note-card {
    border-radius: 10px;
    padding: 12px 16px;
  }

  .note-link {
    display: flex;
    align-items: baseline;
    gap: 14px;
    min-width: 0;
  }

  .note-head {
    display: flex;
    gap: 12px;
    align-items: baseline;
    flex-shrink: 0;
  }

  .note-head h2 {
    margin: 0;
    font-size: 1.1rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    white-space: nowrap;
  }

  .note-preview {
    margin: 0;
    color: var(--muted);
    line-height: 1.5;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
    flex: 1;
    min-width: 0;
  }

  .scheme-card {
    border: 1px solid rgba(29, 233, 214, 0.3);
    border-radius: 16px;
    background: var(--card);
    padding: 16px;
    display: flex;
    flex-direction: column;
    gap: 12px;
    box-shadow: 0 0 24px rgba(29, 233, 214, 0.12);
  }

  .scheme-link {
    display: flex;
    flex-direction: column;
    gap: 12px;
    color: inherit;
  }

  .scheme-title {
    text-transform: uppercase;
    letter-spacing: 0.12em;
    font-size: 0.95rem;
  }

  .scheme-image {
    border-radius: 12px;
    overflow: hidden;
    border: 1px solid rgba(255, 59, 79, 0.2);
    background: rgba(9, 10, 16, 0.7);
  }

  .scheme-image img {
    width: 100%;
    height: auto;
    display: block;
  }

  .note-list.list-mode .scheme-card {
    padding: 10px 12px;
    max-width: 520px;
  }

  .note-list.list-mode .scheme-image img {
    max-height: 220px;
    object-fit: contain;
  }


  @media (max-width: 760px) {
    .note-head {
      flex-shrink: 0;
    }
  }
</style>
